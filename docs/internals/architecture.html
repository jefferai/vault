<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Learn about the internal architecture of Vault.">

    <link rel="shortcut icon" href="/assets/images/favicon.png">

    <title>Architecture - Vault by HashiCorp</title>

    <link href="/assets/stylesheets/application-4b1f25b3.css" rel="stylesheet"/>

    <!--[if lt IE 9]><script src="/assets/javascripts/html5shiv-62fced3a.js" type="text/javascript"></script><script src="/assets/javascripts/respond.min-88c91176.js" type="text/javascript"></script><![endif]-->

    
  </head>

  <body id="page-Architecture" class="page-Architecture layout-docs page-sub">

<div id="header" class="navbar-static-top">
	<div class="container">
        <div class="row">
            <div class="col-md-offset-1 col-md-10 col-xs-12">
                <div class="navbar-header">
                    <div class="navbar-brand">
                         <a class="logo" href="">Vault</a>
                    </div>
                    <ul class="main-links nav navbar-nav navbar-right hidden-xs">
                        <li class="first li-under"><a href="intro/index.html">Intro</a></li>
                        <li class="li-under"><a href="docs/index.html">Docs</a></li>
                        <li class="li-under"><a href="community.html">Community</a></li>
                    </ul>
                    <button class="navbar-toggle" type="button">
                       <span class="sr-only">Toggle navigation</span>
                       <span class="icon-bar"></span>
                       <span class="icon-bar"></span>
                       <span class="icon-bar"></span>
                    </button>                       
                </div>
                <div class="buttons hidden-xs">
            		<nav role="navigation">
            			<ul class="nav navbar-nav navbar-right">
            				<li class="first"><a href="downloads.html">Download</a></li>
            				<li class=""><a href="https://github.com/hashicorp/vault">GitHub</a></li>
            			</ul>
            		</nav>
                </div>
            </div>         
        </div>
    </div>
</div>


<div class="container">
	<div class="row">
		<div class="col-md-offset-1 col-md-2 col-sm-3 col-xs-12">
					<div class="docs-sidebar hidden-print affix-top" role="complementary">
			<ul class="nav docs-sidenav">
				<li>
					<a href="docs/index.html">Documentation Home</a>
				</li>

				<li class="active">
					<a href="docs/internals/index.html">Internals</a>
					<ul class="nav">
						<li class="active">
							<a href="docs/internals/architecture.html">Architecture</a>
                        </li>

						<li>
							<a href="docs/internals/high-availability.html">High Availability</a>
						</li>

						<li>
							<a href="docs/internals/security.html">Security Model</a>
                        </li>

						<li>
							<a href="docs/internals/telemetry.html">Telemetry</a>
                        </li>

						<li>
							<a href="docs/internals/token.html">Token Authentication</a>
						</li>
					</ul>
				</li>

				<li>
					<a href="docs/install/index.html">Installation</a>
				</li>

				<li>
					<a href="docs/concepts/index.html">Basic Concepts</a>
					<ul class="nav">
						<li>
							<a href="docs/concepts/dev-server.html">"Dev" Server</a>
						</li>

						<li>
							<a href="docs/concepts/seal.html">Seal/Unseal</a>
						</li>

						<li>
							<a href="docs/concepts/lease.html">Lease, Renew, and Revoke</a>
						</li>

						<li>
							<a href="docs/concepts/auth.html">Authentication</a>
						</li>

						<li>
							<a href="docs/concepts/tokens.html">Tokens</a>
						</li>

						<li>
							<a href="docs/concepts/policies.html">Access Control Policies</a>
						</li>

						<li>
							<a href="docs/concepts/ha.html">High Availability</a>
						</li>
					</ul>
				</li>

				<li>
					<a href="docs/config/index.html">Configuration</a>
				</li>

				<li>
					<a href="docs/commands/index.html">Commands (CLI)</a>
					<ul class="nav">
						<li>
							<a href="docs/commands/help.html">Help</a>
						</li>

						<li>
							<a href="docs/commands/read-write.html">Reading and Writing Data</a>
						</li>
					</ul>
				</li>

				<li>
					<a href="docs/http/index.html">HTTP API</a>
				</li>

				<hr>

				<li>
					<a href="docs/secrets/index.html">Secret Backends</a>
					<ul class="nav">
						<li>
							<a href="docs/secrets/aws/index.html">AWS</a>
						</li>

						<li>
							<a href="docs/secrets/consul/index.html">Consul</a>
						</li>

						<li>
							<a href="docs/secrets/pki/index.html">PKI (Certificates)</a>
                        </li>

						<li>
							<a href="docs/secrets/postgresql/index.html">PostgreSQL</a>
                        </li>

						<li>
							<a href="docs/secrets/mysql/index.html">MySQL</a>
						</li>

						<li>
							<a href="docs/secrets/transit/index.html">Transit</a>
						</li>

						<li>
							<a href="docs/secrets/generic/index.html">Generic</a>
						</li>

						<li>
							<a href="docs/secrets/custom.html">Custom</a>
						</li>
					</ul>
				</li>

				<li>
					<a href="docs/auth/index.html">Auth Backends</a>
					<ul class="nav">
						<li>
                            <a href="docs/auth/token.html">Tokens</a>
						</li>

						<li>
							<a href="docs/auth/github.html">GitHub</a>
						</li>

						<li>
							<a href="docs/auth/app-id.html">App ID</a>
						</li>

						<li>
							<a href="docs/auth/userpass.html">Username &amp; Password</a>
                        </li>

						<li>
							<a href="docs/auth/cert.html">TLS Certificates</a>
                        </li>

						<li>
							<a href="docs/auth/ldap.html">LDAP</a>
						</li>
					</ul>
				</li>

				<li>
					<a href="docs/audit/index.html">Audit Backends</a>
					<ul class="nav">
						<li>
							<a href="docs/audit/file.html">File</a>
                        </li>

						<li>
							<a href="docs/audit/syslog.html">Syslog</a>
						</li>
					</ul>
				</li>
			</ul>
		</div>

		</div>  
		<div id="main-content" class="col-sm-9 col-md-8 col-xs-12" role="main">
			<div class="bs-docs-section">
				
	<h1>Architecture</h1>
<p>Vault is a complex system that has many different pieces. To help both users and developers of Vault
build a mental model of how it works, this page documents the system architecture.</p>
<div class="alert alert-warning" role="alert">
<p><strong>Advanced Topic!</strong> This page covers technical details
of Vault. You don&#39;t need to understand these details to
effectively use Vault. The details are documented here for
those who wish to learn about them without having to go
spelunking through the source code. However, if you&#39;re an
operator of Vault, we recommend learning about the architecture
due to the importance of Vault in an environment.</p>
</div>

<h1>Glossary</h1>
<p>Before describing the architecture, we provide a glossary of terms to help
clarify what is being discussed:</p>

<ul>
<li><p><strong>Storage Backend</strong> - A storage backend is responsible for durable storage of <em>encrypted</em> data.
backends are not trusted by Vault and are only expected to provide durability. The storage
backend is configured when starting the Vault server.</p>
</li>
<li><p><strong>Barrier</strong> - The barrier is cryptographic steel and concrete around the Vault. All data that
flows between Vault and the Storage Backend passes through the barrier. The barrier ensures
that only encrypted data is written out, and that data is verified and decrypted on the way
in. Much like a bank vault, the barrier must be &quot;unsealed&quot; before anything inside can be accessed.</p>
</li>
<li><p><strong>Secret Backend</strong> - A secret backend is responsible for managing secrets. Simple secret backends
like the &quot;generic&quot; backend simply return the same secret when queried. Some backends support
using policies to dynamically generate a secret each time they are queried. This allows for
unique secrets to be used which allows Vault to do fine-grained revocation and policy updates.
As an example, a MySQL backend could be configured with a &quot;web&quot; policy. When the &quot;web&quot; secret
is read, a new MySQL user/password pair will be generated with a limited set of privileges
for the web server.</p>
</li>
<li><p><strong>Audit Backend</strong> - An audit backend is responsible for managing audit logs. Every request to Vault
and response from Vault goes through the configured audit backends. This provides a simple
way to integrate Vault with multiple audit logging destinations of different types.</p>
</li>
<li><p><strong>Credential Backend</strong> - A credential backend is used to authenticate users or applications which
are connecting to Vault. Once authenticated, the backend returns the list of applicable policies
which should be applied. Vault takes an authenticated user and returns a client token that can
be used for future requests. As an example, the <a name="user_password"/><a href="#user_password"><code>user-password</code></a> backend uses a username and password
to authenticate the user. Alternatively, the <code>github</code> backend allows users to authenticate
via GitHub.</p>
</li>
<li><p><strong>Client Token</strong> - A client token is a conceptually similar to a session cookie on a web site.
Once a user authenticates, Vault returns a client token which is used for future requests.
The token is used by Vault to verify the identity of the client and to enforce the applicable
ACL policies.</p>
</li>
<li><p><strong>Secret</strong> - A secret is the term for anything returned by Vault which contains confidential
or cryptographic material. Not all everything returned by Vault is a secret, for example
system configuration, status information, or backend policies are not considered Secrets.
Secrets always have an associated lease. This means clients cannot assume that the secret
contents can be used indefinitely. Vault will revoke a secret at the end of the lease, and
an operator may intervene to revoke the secret before the lease is over. This contract
between Vault and its clients is critical, as it allows for changes in keys and policies
without manual intervention.</p>
</li>
<li><p><strong>Server</strong> - Vault depends on a long-running instance which operates as a server.
The Vault server provides an API which clients interact with and manages the
interaction between all the backends, ACL enforcement, and secret lease revocation.
Having a server based architecture decouples clients from the security keys and policies,
enables centralized audit logging and simplifies administration for operators.</p>
</li>
</ul>

<h1>High-Level Overview</h1>
<p>A very high level overview of Vault looks like this:</p>
<p><img alt="Architecture Overview" src="/assets/images/assets/images/layers.png"/></p>
<p>Let&#39;s begin to break down this picture. There is a clear separation of components
that are inside or outside of the security barrier. Only the storage backend and
the HTTP API are outside, all other components are inside the barrier.</p>
<p>The storage backend is untrusted and is used to durably store encrypted data. When
the Vault server is started, it must be provided with a storage backend so that data
is available across restarts. The HTTP API similarly must be started by the Vault server
on start so that clients can interact with it.</p>
<p>Once started, the Vault is in a <em>sealed</em> state. Before any operation can be performed
on the Vault it must be unsealed. This is done by providing the unseal keys. When
the Vault is initialized it generates an encryption key which is used to protect all the
data. That key is protected by a master key. By default, Vault uses a technique known
as <a href="http://en.wikipedia.org/wiki/Shamir's_Secret_Sharing">Shamir&#39;s secret sharing algorithm</a>
to split the master key into 5 shares, any 3 of which are required to reconstruct the master
key.</p>
<p><img alt="Keys" src="/assets/images/assets/images/keys.png"/></p>
<p>The number of shares and the minimum threshold required can both be specified. Shamir&#39;s
technique can be disabled, and the master key used directly for unsealing. Once Vault
retrieves the encryption key, it is able to decrypt the data in the storage backend,
and enters the <em>unsealed</em> state. Once unsealed, Vault loads all of the configured
audit, credential and secret backends.</p>
<p>The configuration of those backends must be stored in Vault since they are security
sensitive. Only users with the correct permissions should be able to modify them,
meaning they cannot be specified outside of the barrier. By storing them in Vault,
any changes to them are protected by the ACL system and tracked by audit logs.</p>
<p>After the Vault is unsealed, requests can be processed from the HTTP API to the Core.
The core is used to manage the flow of requests through the system, enforce ACLs,
and ensure audit logging is done.</p>
<p>When a client first connects to Vault, it needs to authenticate. Vault provides
configurable credential backends providing flexibility in the authentication mechanism
used. Human friendly mechanisms such as username/password or GitHub might be
used for operators, while applications may use public/private keys or tokens to authenticate.
An authentication request flows through core and into a credential backend, which determines
if the request is valid and returns a list of associated policies.</p>
<p>Policies are just a named ACL rule. For example, the &quot;root&quot; policy is builtin and
permits access to all resources. You can create any number of named policies with
fine-grained control over paths. Vault operates exclusively in a blacklist mode, meaning
unless access is explicitly granted via a policy the action is not allowed.
Since a user may have multiple policies associated, an action is allowed if any policy
permits it. Policies are stored and managed by an internal policy store. This internal store
is manipulated through the system backend, which is always mounted at <code>sys/</code>.</p>
<p>Once authentication takes place and a credential backend provides a set of applicable
policies, a new client token is generated and managed by the token store. This client token
is sent back to the client, and is used to make future requests. This is similar to
a cookie sent by a website after a user logs in. The client token may have a lease associated
with it depending on the credential backend configuration. This means the client token
may need to be periodically renewed to avoid invalidation.</p>
<p>Once authenticated, requests are made providing the client token. The token is used
to verify the client is authorized and to load the relevant policies. The policies
are used to authorize the client request. The request is then routed to the secret backend,
which is processed depending on the type of backend. If the backend returns a secret,
the core registers it with the expiration manager and attaches the a lease ID.
The lease ID is used by clients to renew or revoke their secret. If a client allows the
lease to expire, the expiration manager automatically revokes the secret.</p>
<p>The core handles logging of requests and responses to the audit broker, which fans the
request out to all the configured audit backends. Outside of the request flow, the core
performs certain background activity. Lease management is critical, as it allows
expired client tokens or secrets to be revoked automatically. Additionally, Vault handles
certain partial failure cases by using write ahead logging with a rollback manager.
This is managed transparently within the core and is not user visible.</p>

<h1>Getting in Depth</h1>
<p>This has been a brief high-level overview of the architecture of Vault. There
are more details available for each of the sub-systems.</p>
<p>For other details, either consult the code, ask in IRC or reach out to the mailing list.</p>


			</div>
		</div>
	</div>
</div>




<script type="text/x-handlebars" data-template-name="demo">
{{outlet}}
</script>

<script type="text/x-handlebars" data-template-name="demo/step">

<div class="instruction-wrapper">
    <div class="instruction">
        <p>
        <strong>{{model.humanName}}</strong>
        </p>

        {{partial model.instructionTemplate}}
    </div>
</div>

<span class="close-terminal" {{action "close"}}>X</span>

<div {{bind-attr class=":demo-terminal fullscreen:fullscreen" }}>
    <div class="log">{{renderedLogs}}</div>

    <form {{action "submitText" on="submit"}}>
        {{#unless isLoading}}${{/unless}} {{input value=currentText class="shell" spellcheck="false"}}
    </form>

    {{#if isLoading}}
    <div class="loading-bar"></div>
    {{/if}}
</div>
</script>

<script type="text/x-handlebars" data-template-name="welcome">
    <p>
        This tutorial is great for getting familiar with the command line
         interface to Vault. As soon as you opened this terminal, you connected to a real in-memory Vault server.
        Any commands you enter will work as they would with Vault normally, but leaving this page
        will end the session.
    </p>
    <p>
     Please note that this is running in a shared environment, so avoid setting any real secrets.
    </p>
    <p>
        <strong>Use the command "next" to move forward</strong>.
    </p>
    <p>This will work throughout
        the tutorial, along with "previous" to go back a step.
    </p>
</script>


<script type="text/x-handlebars" data-template-name="steps">
    <p>
        This tutorial will cover the following steps:
    </p>
    <ul>
        <li>- Initializing and unsealing your Vault</li>
        <li>- Authorizing your requests to Vault</li>
        <li>- Reading and writing secrets</li>
        <li>- Sealing your Vault</li>
    </ul>
    <p>
        <strong>Again, use "next" to move to the first step â€“ initializing your Vault</strong>.
    </p>
</script>

<script type="text/x-handlebars" data-template-name="init">
    <p>
        To get started, we need to initialize an instance of Vault for you
        to work with.
    </p>
    <p>
        While initializing, you can configure the seal behavior
        of Vault.
        </p>
    <p>
        Initialize Vault now, with 1 unseal key for simplicity, using the command:
    </p>
    <p>
        <code>vault init -key-shares=1 -key-threshold=1</code>
    </p>
    <p>
        You'll notice Vault prints out several keys here. Don't clear your terminal,
        as these are needed in the next few steps.
    </p>
</script>

<script type="text/x-handlebars" data-template-name="unseal">
    <p>
        When a Vault server is started, it starts in a sealed state.
         In this state, Vault is configured to know where and how to access the
         physical storage, but doesn't know how to decrypt any of it.
    </p>
    <p>
        Vault encrypts data with an encryption key. This key is encrypted with the "master key", which
        isn't stored. Decrypting the master key requires a threshold of shards. In this example,
        we use one shard to decrypt this master key.
    </p>
    <p>
        Unseal the Vault:
    </p>
    <p>
        <code>vault unseal &lt;key 1&gt;</code>
    </p>
</script>

<script type="text/x-handlebars" data-template-name="auth">
    <p>
        Before performing any operation with Vault, the
        connecting client must be authenticated. Authentication is
        the process of verifying a person or machine is who they say
        they are and assigning an identity to them. This identity is then
        used when making requests with Vault.
    </p>
    <p>
        For simplicity, we'll use the root token we generated on init in Step 2. This
        output should be available in the scrollback.
    </p>
    <p>
        Authorize with a client token:
    </p>
    <p>
        <code>vault auth &lt;root token&gt;</code>
    </p>
</script>

<script type="text/x-handlebars" data-template-name="secrets">
    <p>
        Now that Vault has been set-up, we can start reading and writing secrets
        with the default mounted secret backend. Secrets written to Vault
        are encrypted and then written to the backend storage.
        The backend storage mechanism never sees the unencrypted
        value and doesn't have the means necessary to decrypt
        it without Vault.
    </p>
    <p>
        <code>vault write secret/hello value=world</code>
    </p>
    <p>
        Of course, you can then read this data too:
    </p>
    <p>
        <code>vault read secret/hello</code>
    </p>
</script>

<script type="text/x-handlebars" data-template-name="seal">
    <p>
        There is also an API to seal the Vault. This will throw
        away the encryption key and require another unseal process
        to restore it. Sealing only requires a single operator
        with root privileges. This is typically part of a rare "break glass
        procedure".
    </p>
    <p>
        This way, if there is a detected intrusion, the Vault data can be locked
        quickly to try to minimize damages. It can't be accessed again
        without access to the master key shards.
    </p>
    <p>
        <code>vault seal</code>
    </p>
</script>

<script type="text/x-handlebars" data-template-name="finish">
    <p>
        Thanks for trying out the Vault CLI. If you want to keep playing with
        commands, use "fu" to go fullscreen.
    </p>
    <p>
        Note that the Vault CLI uses the HTTP API, which gives you full access to Vault. Every aspect
        of Vault can be controlled via this API.
    </p>
    <p>
        We recommend reading through the <a href="intro/index.html">intro guide</a> next, which will
        provide more background information, use cases and examples.
    </p>
</script>

	<div id="footer">
		<div class="container">
			<div class="row">
				<div class="col-md-offset-1 col-md-5 col-sm-6 col-xs-12">
					<ul class="footer-links nav navbar-nav">
						<li class="li-under"><a href="intro/index.html">Intro</a></li>
						<li class="li-under"><a href="docs/index.html">Docs</a></li>
						<li class="li-under"><a href="community.html">Community</a></li>
						<li class="li-under"><a href="security.html">Security</a></li>
					</ul>
				</div>
				<div class="footer-hashi col-md-5 col-sm-6 col-xs-12">
					<div class="pull-right">
						<span>A <a href="https://www.hashicorp.com">HashiCorp</a> Project.</span>
						<a class="hashi-logo" href="https://www.hashicorp.com"><i class="hashi-logo"></i></a>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-62364009-1', 'auto');
  ga('send', 'pageview');
</script>

<script src="/assets/javascripts/application-e782a4a8.js" type="text/javascript"></script>

</body>
</html>